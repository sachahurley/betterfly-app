<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Phone Number - Betterfly</title>
    <link rel="stylesheet" href="styles/shared.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Add libphonenumber-js for phone validation and formatting -->
    <script src="https://unpkg.com/libphonenumber-js@1.10.44/bundle/libphonenumber-max.js"></script>
    <style>
        .signup-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        
        .signup-content {
            flex: 1;
            padding: 32px 24px 60px;
        }
        
        .signup-title {
            font-family: 'Obviously', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 28px;
            font-weight: 700;
            font-stretch: condensed;
            color: var(--text-primary);
            margin-bottom: 32px;
            text-align: left;
        }
        
        .signup-subtitle {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-bottom: 32px;
            text-align: left;
            line-height: 1.5;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }
        
        .phone-input-container {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }
        
        .country-code-dropdown {
            position: relative;
            flex-shrink: 0;
            width: 80px;
        }
        
        .country-code-button {
            width: 100%;
            height: 56px;
            padding: 0 8px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .country-code-button:hover {
            border-color: #10b981;
        }
        
        .country-code-button:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .country-flag {
            font-size: 20px;
            line-height: 1;
        }
        
        .country-code-text {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 500;
        }
        
        .dropdown-chevron {
            width: 12px;
            height: 12px;
            color: #6b7280;
            transition: transform 0.2s ease;
        }
        
        .country-code-button.open .dropdown-chevron {
            transform: rotate(180deg);
        }
        
        .country-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            width: max-content;
            min-width: 200px;
            max-width: 320px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }
        
        .country-search-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-bottom: 1px solid #e5e7eb;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            background: white;
            outline: none;
            border-radius: 12px 12px 0 0;
        }
        
        .country-search-input::placeholder {
            color: #9ca3af;
        }
        
        .country-dropdown-menu.open {
            display: block;
        }
        
        .country-option {
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .country-option:last-child {
            border-bottom: none;
        }
        
        .country-option:hover {
            background-color: #f9fafb;
        }
        
        .country-option.selected {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .country-option-flag {
            font-size: 20px;
        }
        
        .country-option-details {
            flex: 1;
            min-width: 0;
        }
        
        .country-option-name {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .country-option-code {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 400;
            color: var(--text-secondary);
        }
        
        .phone-input {
            flex: 1;
            padding: 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            color: var(--text-primary);
            background: white;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .phone-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .phone-input.error {
            border-color: #ef4444;
        }
        
        .phone-input::placeholder {
            color: #9ca3af;
        }
        
        .error-message {
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            color: #ef4444;
            margin-top: 4px;
            display: none;
        }
        
        .phone-input.error + .error-message {
            display: block;
        }
        
        .sms-detail-text {
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-top: 16px;
            text-align: left;
        }
        
        .signup-cta-section {
            padding: 0 24px 24px;
            background: white;
        }
        
        .btn-primary.signup-btn {
            width: 100%;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 400;
            border-radius: 24px;
            border: none;
            background: #0F1C14;
            color: white;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary.signup-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* iOS Keyboard Toolbar */
        .ios-keyboard-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f2f2f7;
            border-top: 1px solid #c6c6c8;
            padding: 8px 16px;
            display: none;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
            height: 44px;
        }
        
        .ios-keyboard-toolbar.visible {
            display: flex;
        }
        
        .ios-toolbar-title {
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 13px;
            font-weight: 400;
            color: #8e8e93;
        }
        
        .ios-toolbar-actions {
            display: flex;
            gap: 16px;
        }
        
        .ios-toolbar-btn {
            background: none;
            border: none;
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 17px;
            font-weight: 400;
            color: #007aff;
            cursor: pointer;
            padding: 0;
            transition: opacity 0.2s ease;
        }
        
        .ios-toolbar-btn:hover {
            opacity: 0.7;
        }
        
        .ios-toolbar-btn:active {
            opacity: 0.3;
        }
        
        .ios-toolbar-btn.primary {
            font-weight: 600;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .phone-input-container {
                gap: 8px;
            }
            
            .country-code-dropdown {
                width: 72px;
            }
            
            .country-code-button {
                padding: 0 6px;
            }
            
            .country-code-text {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="signup-container">
        
        <div id="backButtonContainer"></div>
        
        <div class="signup-content">
            <div id="progressContainer"></div>
            <h1 class="signup-title">What is your phone number?</h1>
            
            <form id="phoneForm">
                <div class="form-group">
                    <label class="form-label" for="phoneNumber">Phone Number</label>
                    <div class="phone-input-container">
                        <div class="country-code-dropdown">
                            <button type="button" 
                                    class="country-code-button" 
                                    id="countryCodeButton"
                                    aria-label="Select country code"
                                    aria-expanded="false"
                                    aria-haspopup="listbox">
                                <span class="country-flag" id="selectedFlag">ðŸ‡ºðŸ‡¸</span>
                                <span class="country-code-text" id="selectedCode">+1</span>
                                <i data-lucide="chevron-down" class="dropdown-chevron"></i>
                            </button>
                            <div class="country-dropdown-menu" 
                                 id="countryDropdown"
                                 role="listbox"
                                 aria-label="Country selection">
                                <input type="text" 
                                       class="country-search-input" 
                                       id="countrySearchInput" 
                                       placeholder="Search countries..."
                                       aria-label="Search countries" />
                                <div class="country-options-list" id="countryOptionsList">
                                    <!-- Country options will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <input 
                            type="tel" 
                            id="phoneNumber" 
                            name="phoneNumber"
                            class="phone-input" 
                            placeholder="(555) 123-4567"
                            autocomplete="tel"
                            inputmode="numeric"
                            aria-label="Phone number"
                            aria-describedby="sms-detail-text"
                            required
                        />
                    </div>
                    <span class="error-message">Please enter a valid phone number</span>
                    <p class="sms-detail-text" id="sms-detail-text">You will receive an SMS to verify your phone. Standard SMS rates may apply.</p>
                </div>
            </form>
        </div>
        
        <div class="signup-cta-section">
            <button id="nextBtn" class="btn-primary signup-btn" disabled>
                Next
            </button>
        </div>
        
        <!-- iOS Keyboard Toolbar -->
        <div class="ios-keyboard-toolbar" id="keyboardToolbar">
            <div class="ios-toolbar-title">Phone Number</div>
            <div class="ios-toolbar-actions">
                <button type="button" class="ios-toolbar-btn" id="autoFillBtn">AutoFill</button>
                <button type="button" class="ios-toolbar-btn primary" id="doneBtn">Done</button>
            </div>
        </div>
    </div>

    <script src="state.js"></script>
    <script src="routes.js"></script>
    <script src="components/components.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load state
            OnboardingState.load();
            
            // Mount back button
            BackButton.mount('backButtonContainer', {
                title: 'Phone Number'
            });
            
            // Mount progress bar (step 2 of 3: name, phone, password)
            ProgressBar.mount('progressContainer', 2, 3);
            
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Form elements
            const phoneInput = document.getElementById('phoneNumber');
            const nextBtn = document.getElementById('nextBtn');
            const phoneForm = document.getElementById('phoneForm');
            const countryCodeButton = document.getElementById('countryCodeButton');
            const countryDropdown = document.getElementById('countryDropdown');
            const selectedFlag = document.getElementById('selectedFlag');
            const selectedCode = document.getElementById('selectedCode');
            const keyboardToolbar = document.getElementById('keyboardToolbar');
            const autoFillBtn = document.getElementById('autoFillBtn');
            const doneBtn = document.getElementById('doneBtn');
            
            // Enhanced country data with comprehensive list
            const countryData = [
                { code: 'US', dialCode: '+1', name: 'United States', flag: 'ðŸ‡ºðŸ‡¸' },
                { code: 'CA', dialCode: '+1', name: 'Canada', flag: 'ðŸ‡¨ðŸ‡¦' },
                { code: 'GB', dialCode: '+44', name: 'United Kingdom', flag: 'ðŸ‡¬ðŸ‡§' },
                { code: 'AU', dialCode: '+61', name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º' },
                { code: 'DE', dialCode: '+49', name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª' },
                { code: 'FR', dialCode: '+33', name: 'France', flag: 'ðŸ‡«ðŸ‡·' },
                { code: 'ES', dialCode: '+34', name: 'Spain', flag: 'ðŸ‡ªðŸ‡¸' },
                { code: 'IT', dialCode: '+39', name: 'Italy', flag: 'ðŸ‡®ðŸ‡¹' },
                { code: 'NL', dialCode: '+31', name: 'Netherlands', flag: 'ðŸ‡³ðŸ‡±' },
                { code: 'MX', dialCode: '+52', name: 'Mexico', flag: 'ðŸ‡²ðŸ‡½' },
                { code: 'BR', dialCode: '+55', name: 'Brazil', flag: 'ðŸ‡§ðŸ‡·' },
                { code: 'AR', dialCode: '+54', name: 'Argentina', flag: 'ðŸ‡¦ðŸ‡·' },
                { code: 'IN', dialCode: '+91', name: 'India', flag: 'ðŸ‡®ðŸ‡³' },
                { code: 'CN', dialCode: '+86', name: 'China', flag: 'ðŸ‡¨ðŸ‡³' },
                { code: 'JP', dialCode: '+81', name: 'Japan', flag: 'ðŸ‡¯ðŸ‡µ' },
                { code: 'KR', dialCode: '+82', name: 'South Korea', flag: 'ðŸ‡°ðŸ‡·' },
                { code: 'SG', dialCode: '+65', name: 'Singapore', flag: 'ðŸ‡¸ðŸ‡¬' },
                { code: 'CH', dialCode: '+41', name: 'Switzerland', flag: 'ðŸ‡¨ðŸ‡­' },
                { code: 'SE', dialCode: '+46', name: 'Sweden', flag: 'ðŸ‡¸ðŸ‡ª' },
                { code: 'NO', dialCode: '+47', name: 'Norway', flag: 'ðŸ‡³ðŸ‡´' },
                { code: 'DK', dialCode: '+45', name: 'Denmark', flag: 'ðŸ‡©ðŸ‡°' },
                { code: 'FI', dialCode: '+358', name: 'Finland', flag: 'ðŸ‡«ðŸ‡®' },
                { code: 'BE', dialCode: '+32', name: 'Belgium', flag: 'ðŸ‡§ðŸ‡ª' },
                { code: 'AT', dialCode: '+43', name: 'Austria', flag: 'ðŸ‡¦ðŸ‡¹' },
                { code: 'IE', dialCode: '+353', name: 'Ireland', flag: 'ðŸ‡®ðŸ‡ª' },
                { code: 'PT', dialCode: '+351', name: 'Portugal', flag: 'ðŸ‡µðŸ‡¹' },
                { code: 'GR', dialCode: '+30', name: 'Greece', flag: 'ðŸ‡¬ðŸ‡·' },
                { code: 'PL', dialCode: '+48', name: 'Poland', flag: 'ðŸ‡µðŸ‡±' },
                { code: 'CZ', dialCode: '+420', name: 'Czech Republic', flag: 'ðŸ‡¨ðŸ‡¿' },
                { code: 'HU', dialCode: '+36', name: 'Hungary', flag: 'ðŸ‡­ðŸ‡º' },
                { code: 'RO', dialCode: '+40', name: 'Romania', flag: 'ðŸ‡·ðŸ‡´' },
                { code: 'BG', dialCode: '+359', name: 'Bulgaria', flag: 'ðŸ‡§ðŸ‡¬' },
                { code: 'HR', dialCode: '+385', name: 'Croatia', flag: 'ðŸ‡­ðŸ‡·' },
                { code: 'RS', dialCode: '+381', name: 'Serbia', flag: 'ðŸ‡·ðŸ‡¸' },
                { code: 'SI', dialCode: '+386', name: 'Slovenia', flag: 'ðŸ‡¸ðŸ‡®' },
                { code: 'SK', dialCode: '+421', name: 'Slovakia', flag: 'ðŸ‡¸ðŸ‡°' },
                { code: 'EE', dialCode: '+372', name: 'Estonia', flag: 'ðŸ‡ªðŸ‡ª' },
                { code: 'LV', dialCode: '+371', name: 'Latvia', flag: 'ðŸ‡±ðŸ‡»' },
                { code: 'LT', dialCode: '+370', name: 'Lithuania', flag: 'ðŸ‡±ðŸ‡¹' },
                { code: 'IL', dialCode: '+972', name: 'Israel', flag: 'ðŸ‡®ðŸ‡±' },
                { code: 'AE', dialCode: '+971', name: 'United Arab Emirates', flag: 'ðŸ‡¦ðŸ‡ª' },
                { code: 'SA', dialCode: '+966', name: 'Saudi Arabia', flag: 'ðŸ‡¸ðŸ‡¦' },
                { code: 'TR', dialCode: '+90', name: 'Turkey', flag: 'ðŸ‡¹ðŸ‡·' },
                { code: 'EG', dialCode: '+20', name: 'Egypt', flag: 'ðŸ‡ªðŸ‡¬' },
                { code: 'ZA', dialCode: '+27', name: 'South Africa', flag: 'ðŸ‡¿ðŸ‡¦' },
                { code: 'NG', dialCode: '+234', name: 'Nigeria', flag: 'ðŸ‡³ðŸ‡¬' },
                { code: 'KE', dialCode: '+254', name: 'Kenya', flag: 'ðŸ‡°ðŸ‡ª' },
                { code: 'GH', dialCode: '+233', name: 'Ghana', flag: 'ðŸ‡¬ðŸ‡­' },
                { code: 'MA', dialCode: '+212', name: 'Morocco', flag: 'ðŸ‡²ðŸ‡¦' },
                { code: 'TN', dialCode: '+216', name: 'Tunisia', flag: 'ðŸ‡¹ðŸ‡³' },
                { code: 'DZ', dialCode: '+213', name: 'Algeria', flag: 'ðŸ‡©ðŸ‡¿' },
                { code: 'RU', dialCode: '+7', name: 'Russia', flag: 'ðŸ‡·ðŸ‡º' },
                { code: 'UA', dialCode: '+380', name: 'Ukraine', flag: 'ðŸ‡ºðŸ‡¦' },
                { code: 'BY', dialCode: '+375', name: 'Belarus', flag: 'ðŸ‡§ðŸ‡¾' },
                { code: 'KZ', dialCode: '+7', name: 'Kazakhstan', flag: 'ðŸ‡°ðŸ‡¿' },
                { code: 'UZ', dialCode: '+998', name: 'Uzbekistan', flag: 'ðŸ‡ºðŸ‡¿' },
                { code: 'TH', dialCode: '+66', name: 'Thailand', flag: 'ðŸ‡¹ðŸ‡­' },
                { code: 'VN', dialCode: '+84', name: 'Vietnam', flag: 'ðŸ‡»ðŸ‡³' },
                { code: 'MY', dialCode: '+60', name: 'Malaysia', flag: 'ðŸ‡²ðŸ‡¾' },
                { code: 'ID', dialCode: '+62', name: 'Indonesia', flag: 'ðŸ‡®ðŸ‡©' },
                { code: 'PH', dialCode: '+63', name: 'Philippines', flag: 'ðŸ‡µðŸ‡­' },
                { code: 'PK', dialCode: '+92', name: 'Pakistan', flag: 'ðŸ‡µðŸ‡°' },
                { code: 'BD', dialCode: '+880', name: 'Bangladesh', flag: 'ðŸ‡§ðŸ‡©' },
                { code: 'LK', dialCode: '+94', name: 'Sri Lanka', flag: 'ðŸ‡±ðŸ‡°' },
                { code: 'NP', dialCode: '+977', name: 'Nepal', flag: 'ðŸ‡³ðŸ‡µ' },
                { code: 'AF', dialCode: '+93', name: 'Afghanistan', flag: 'ðŸ‡¦ðŸ‡«' },
                { code: 'IR', dialCode: '+98', name: 'Iran', flag: 'ðŸ‡®ðŸ‡·' },
                { code: 'IQ', dialCode: '+964', name: 'Iraq', flag: 'ðŸ‡®ðŸ‡¶' },
                { code: 'SY', dialCode: '+963', name: 'Syria', flag: 'ðŸ‡¸ðŸ‡¾' },
                { code: 'LB', dialCode: '+961', name: 'Lebanon', flag: 'ðŸ‡±ðŸ‡§' },
                { code: 'JO', dialCode: '+962', name: 'Jordan', flag: 'ðŸ‡¯ðŸ‡´' },
                { code: 'KW', dialCode: '+965', name: 'Kuwait', flag: 'ðŸ‡°ðŸ‡¼' },
                { code: 'QA', dialCode: '+974', name: 'Qatar', flag: 'ðŸ‡¶ðŸ‡¦' },
                { code: 'BH', dialCode: '+973', name: 'Bahrain', flag: 'ðŸ‡§ðŸ‡­' },
                { code: 'OM', dialCode: '+968', name: 'Oman', flag: 'ðŸ‡´ðŸ‡²' },
                { code: 'YE', dialCode: '+967', name: 'Yemen', flag: 'ðŸ‡¾ðŸ‡ª' }
            ];

            let selectedCountry = { code: 'US', dialCode: '+1', name: 'United States', flag: 'ðŸ‡ºðŸ‡¸' };
            let allCountries = [...countryData];

            // Auto-detect user's country by IP (simplified implementation)
            async function detectUserCountry() {
                try {
                    const response = await fetch('https://ipapi.co/country/');
                    const countryCode = await response.text();
                    const detectedCountry = countryData.find(c => c.code === countryCode.toUpperCase());
                    if (detectedCountry) {
                        return detectedCountry;
                    }
                } catch (error) {
                    console.log('Country detection failed, using default US');
                }
                return countryData[0]; // Default to US
            }

            // Initialize country options in dropdown
            function populateCountryDropdown(countries = allCountries) {
                const container = document.getElementById('countryOptionsList');
                container.innerHTML = '';
                
                countries.forEach(country => {
                    const option = document.createElement('div');
                    option.className = 'country-option';
                    option.role = 'option';
                    option.setAttribute('aria-label', `${country.name} ${country.dialCode}`);
                    if (country.code === selectedCountry.code) {
                        option.classList.add('selected');
                        option.setAttribute('aria-selected', 'true');
                    } else {
                        option.setAttribute('aria-selected', 'false');
                    }
                    option.dataset.country = country.code;
                    option.dataset.code = country.dialCode;
                    option.dataset.flag = country.flag;
                    option.dataset.name = country.name;
                    
                    option.innerHTML = `
                        <span class="country-option-flag">${country.flag}</span>
                        <div class="country-option-details">
                            <div class="country-option-name">${country.name}</div>
                            <div class="country-option-code">${country.dialCode}</div>
                        </div>
                    `;
                    
                    container.appendChild(option);
                });
            }

            // Enhanced phone formatting using libphonenumber
            function formatPhoneNumber(value, countryCode) {
                try {
                    if (!value.trim()) return '';
                    
                    // Parse the phone number
                    const phoneNumber = window.libphonenumber.parsePhoneNumber(value, countryCode);
                    if (phoneNumber && phoneNumber.isValid()) {
                        return phoneNumber.formatNational();
                    } else {
                        // Fallback to simple formatting for partial input
                        const cleaned = value.replace(/\D/g, '');
                        if (countryCode === 'US' || countryCode === 'CA') {
                            if (cleaned.length <= 3) return cleaned;
                            if (cleaned.length <= 6) return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
                            return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
                        }
                        return cleaned.replace(/(\d{3})(?=\d)/g, '$1 ');
                    }
                } catch (error) {
                    // Fallback formatting
                    const cleaned = value.replace(/\D/g, '');
                    if (countryCode === 'US' || countryCode === 'CA') {
                        if (cleaned.length <= 3) return cleaned;
                        if (cleaned.length <= 6) return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
                        return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
                    }
                    return cleaned.replace(/(\d{3})(?=\d)/g, '$1 ');
                }
            }

            // Enhanced phone validation using libphonenumber
            function validatePhone(value, countryCode) {
                try {
                    if (!value.trim()) return false;
                    
                    const phoneNumber = window.libphonenumber.parsePhoneNumber(value, countryCode);
                    return phoneNumber && phoneNumber.isValid();
                } catch (error) {
                    // Fallback validation
                    const cleaned = value.replace(/\D/g, '');
                    if (countryCode === 'US' || countryCode === 'CA') {
                        return cleaned.length === 10;
                    }
                    return cleaned.length >= 7 && cleaned.length <= 15;
                }
            }

            // Auto-detect country from phone number input
            function detectCountryFromPhone(phoneValue) {
                try {
                    if (!phoneValue.trim()) return null;
                    
                    // Try to parse without country code first
                    const phoneNumber = window.libphonenumber.parsePhoneNumber(phoneValue);
                    if (phoneNumber && phoneNumber.country) {
                        const detectedCountry = countryData.find(c => c.code === phoneNumber.country);
                        return detectedCountry;
                    }
                } catch (error) {
                    // If parsing fails, try to detect from dial code
                    const cleaned = phoneValue.replace(/\D/g, '');
                    if (cleaned.startsWith('1') && cleaned.length >= 10) {
                        return countryData.find(c => c.code === 'US');
                    }
                }
                return null;
            }

            // Get placeholder for selected country
            function getPlaceholderForCountry(countryCode) {
                const placeholders = {
                    'US': '(555) 123-4567',
                    'CA': '(555) 123-4567', 
                    'GB': '07700 900123',
                    'AU': '0412 345 678',
                    'DE': '0151 23456789',
                    'FR': '06 12 34 56 78',
                    'ES': '612 34 56 78',
                    'IT': '312 345 6789',
                    'NL': '06 12345678',
                    'MX': '55 1234 5678'
                };
                return placeholders[countryCode] || 'Enter phone number';
            }
            
            // Initialize country dropdown and auto-detect
            async function initializeCountrySelection() {
                try {
                    const detectedCountry = await detectUserCountry();
                    selectedCountry = detectedCountry;
                    
                    // Update UI
                    selectedFlag.textContent = selectedCountry.flag;
                    selectedCode.textContent = selectedCountry.dialCode;
                    phoneInput.placeholder = getPlaceholderForCountry(selectedCountry.code);
                    
                    // Populate dropdown
                    populateCountryDropdown();
                } catch (error) {
                    console.log('Failed to initialize country selection');
                    populateCountryDropdown();
                }
            }

            // Search functionality for country dropdown
            const countrySearchInput = document.getElementById('countrySearchInput');
            countrySearchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCountries = allCountries.filter(country => 
                    country.name.toLowerCase().includes(searchTerm) ||
                    country.dialCode.includes(searchTerm) ||
                    country.code.toLowerCase().includes(searchTerm)
                );
                populateCountryDropdown(filteredCountries);
            });

            // Enhanced phone input handler with auto-detection
            phoneInput.addEventListener('input', function(e) {
                let inputValue = e.target.value;
                
                // Auto-detect country from phone number if user enters with country code
                if (inputValue.startsWith('+')) {
                    const detectedCountry = detectCountryFromPhone(inputValue);
                    if (detectedCountry && detectedCountry.code !== selectedCountry.code) {
                        selectedCountry = detectedCountry;
                        selectedFlag.textContent = selectedCountry.flag;
                        selectedCode.textContent = selectedCountry.dialCode;
                        phoneInput.placeholder = getPlaceholderForCountry(selectedCountry.code);
                        populateCountryDropdown();
                    }
                }
                
                // Format the input
                const formatted = formatPhoneNumber(inputValue, selectedCountry.code);
                e.target.value = formatted;
                validateForm();
            });
            
            // Enhanced validation function
            function validateForm() {
                const phoneValid = validatePhone(phoneInput.value, selectedCountry.code);
                
                // Update button state
                nextBtn.disabled = !phoneValid;
                
                // Update input styling with better error messaging
                if (phoneInput.value.length > 0) {
                    if (phoneValid) {
                        phoneInput.classList.remove('error');
                    } else {
                        phoneInput.classList.add('error');
                        // Update error message based on country
                        const errorMsg = document.querySelector('.error-message');
                        if (errorMsg) {
                            errorMsg.textContent = `Please enter a valid ${selectedCountry.name} phone number`;
                        }
                    }
                } else {
                    phoneInput.classList.remove('error');
                }
                
                return phoneValid;
            }

            // Update country selection function
            function updateSelectedCountry(country) {
                selectedCountry = country;
                
                // Update UI elements
                selectedFlag.textContent = country.flag;
                selectedCode.textContent = country.dialCode;
                phoneInput.placeholder = getPlaceholderForCountry(country.code);
                
                // Update selected state in dropdown
                document.querySelectorAll('.country-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.country === country.code) {
                        opt.classList.add('selected');
                    }
                });
                
                // Reformat existing phone number for new country
                if (phoneInput.value) {
                    const cleaned = phoneInput.value.replace(/\D/g, '');
                    phoneInput.value = formatPhoneNumber(cleaned, country.code);
                    validateForm();
                }
            }
            
            // Enhanced country dropdown functionality
            countryCodeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                const isOpen = countryDropdown.classList.contains('open');
                
                if (isOpen) {
                    countryDropdown.classList.remove('open');
                    countryCodeButton.classList.remove('open');
                    countryCodeButton.setAttribute('aria-expanded', 'false');
                } else {
                    countryDropdown.classList.add('open');
                    countryCodeButton.classList.add('open');
                    countryCodeButton.setAttribute('aria-expanded', 'true');
                    // Focus search input when opened
                    setTimeout(() => countrySearchInput.focus(), 100);
                }
            });
            
            // Prevent search input clicks from closing dropdown
            countrySearchInput.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!countryCodeButton.contains(e.target) && !countryDropdown.contains(e.target)) {
                    countryDropdown.classList.remove('open');
                    countryCodeButton.classList.remove('open');
                    countryCodeButton.setAttribute('aria-expanded', 'false');
                    countrySearchInput.value = ''; // Clear search
                    populateCountryDropdown(); // Reset list
                }
            });
            
            // Handle country selection
            document.addEventListener('click', function(e) {
                const option = e.target.closest('.country-option');
                if (option && countryDropdown.contains(option)) {
                    const country = {
                        code: option.dataset.country,
                        dialCode: option.dataset.code,
                        name: option.dataset.name,
                        flag: option.dataset.flag
                    };
                    
                    updateSelectedCountry(country);
                    
                    // Close dropdown
                    countryDropdown.classList.remove('open');
                    countryCodeButton.classList.remove('open');
                    countryCodeButton.setAttribute('aria-expanded', 'false');
                    countrySearchInput.value = ''; // Clear search
                    populateCountryDropdown(); // Reset list
                }
            });

            // Keyboard navigation for country search
            countrySearchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    countryDropdown.classList.remove('open');
                    countryCodeButton.classList.remove('open');
                    countryCodeButton.setAttribute('aria-expanded', 'false');
                    countrySearchInput.value = '';
                    populateCountryDropdown();
                    phoneInput.focus();
                }
            });
            
            // iOS Keyboard Toolbar functionality
            phoneInput.addEventListener('focus', function() {
                // Show toolbar on mobile devices
                if (window.innerWidth <= 768) {
                    keyboardToolbar.classList.add('visible');
                }
            });
            
            phoneInput.addEventListener('blur', function() {
                // Hide toolbar when input loses focus (with delay to allow button clicks)
                setTimeout(() => {
                    keyboardToolbar.classList.remove('visible');
                }, 200);
            });
            
            // AutoFill button
            autoFillBtn.addEventListener('click', function() {
                phoneInput.value = formatPhoneNumber('6502399898', selectedCountry.code);
                validateForm();
                phoneInput.focus();
            });
            
            // Done button
            doneBtn.addEventListener('click', function() {
                phoneInput.blur();
                keyboardToolbar.classList.remove('visible');
            });
            
            // Initialize the enhanced phone input
            async function initializePhoneInput() {
                // Initialize country selection with auto-detection
                await initializeCountrySelection();
                
                // Restore existing data if available
                const existingPhone = OnboardingState.get('profile.phoneNumber');
                const existingCountryCode = OnboardingState.get('profile.countryCode');
                
                if (existingCountryCode) {
                    const existingCountry = countryData.find(c => c.dialCode === existingCountryCode);
                    if (existingCountry) {
                        updateSelectedCountry(existingCountry);
                    }
                }
                
                if (existingPhone) {
                    phoneInput.value = existingPhone;
                    validateForm();
                }
            }
            
            // Initialize everything
            initializePhoneInput();
            
            // Handle next button with E.164 formatting
            nextBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (validateForm()) {
                    try {
                        // Parse and format phone number in E.164 format for backend
                        const phoneNumber = window.libphonenumber.parsePhoneNumber(phoneInput.value, selectedCountry.code);
                        const e164Number = phoneNumber ? phoneNumber.format('E.164') : phoneInput.value;
                        
                        // Save to state
                        OnboardingState.update('profile.phoneNumber', phoneInput.value); // Display format
                        OnboardingState.update('profile.phoneNumberE164', e164Number); // Backend format
                        OnboardingState.update('profile.countryCode', selectedCountry.dialCode);
                        OnboardingState.update('profile.countryISO', selectedCountry.code);
                        OnboardingState.update('profile.countryFlag', selectedCountry.flag);
                        OnboardingState.update('profile.countryName', selectedCountry.name);
                        
                        // Navigate to verification step
                        OnboardingRoutes.navigate('signup-verification');
                    } catch (error) {
                        console.error('Error processing phone number:', error);
                        // Fallback - save as entered
                        OnboardingState.update('profile.phoneNumber', phoneInput.value);
                        OnboardingState.update('profile.countryCode', selectedCountry.dialCode);
                        OnboardingState.update('profile.countryISO', selectedCountry.code);
                        OnboardingRoutes.navigate('signup-verification');
                    }
                }
            });
            
            // Handle form submission
            phoneForm.addEventListener('submit', function(e) {
                e.preventDefault();
                nextBtn.click();
            });
        });
    </script>
</body>
</html>